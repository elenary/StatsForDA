# Сравнение средних по группам {#stats_criteria_ttest_anova} 

```{r, eval=TRUE, echo = FALSE, message = FALSE}
library(tidyverse)
library(kableExtra)
library(viridis)
studens_mat <- read_csv("student-mat.csv") %>% 
  rename_with(., ~ paste0(., "_mat"), .cols = c(absences, paid, G1, G2, G3)) -> studens_mat 
studens_por <- read_csv("student-por.csv") %>% 
  rename_with(., ~ paste0(., "_por"), .cols = c(absences, paid, G1, G2, G3)) -> studens_por
studens_mat %>% 
  full_join(studens_por, by = c("school","sex","age","address","famsize","Pstatus","Medu","Fedu",
                             "Mjob","Fjob","reason", "guardian", "traveltime","studytime", "failures", "schoolsup", "famsup",
                             "activities", "nursery", "higher", "internet", "romantic", "famrel", "freetime", "goout", 
                             "Dalc", "Walc", "health")) -> students 

students %>% 
  mutate("student" = paste0("id", row_number()), .before = "school")  %>% 
  drop_na() %>% 
  mutate(G_mat = rowMeans(dplyr::select(., c(G1_mat, G2_mat, G3_mat))),
         G_por = rowMeans(dplyr::select(., c(G1_por, G2_por, G3_por)))) %>% 
  mutate(absences_mat_groups = ifelse(absences_mat <=5, "less", ifelse(absences_mat <=15, "middle", "more"))) %>% 
  mutate(absences_por_groups = ifelse(absences_por <=5, "less", ifelse(absences_por <=15, "middle", "more"))) -> students
```

## T-тест {#ttest}

Первым из статистических критериев мы рассмотрим один из самых простых вариантов -- т-тест.

Это статистический критерий, распределение которого относится к семейству Т-распределений -- очень похоже на нормальное, но с более приподнятыми хвостами. Используется для сравнения средних двух групп, измеренных в метрической (количественной) шкале. Для остальных шкал т-тест не подходит *(хотя признаки, измеренные по шкале Лайкерта, например, по шкале от 1 до 5, иногда могут приписываться к количественным измерениям, но в рамках этого курса мы не будем это затрагивать)*

Нулевая и альтернативная гипотезы:

<p align="center">$H_0$: $\mu_1 = \mu_2$ </p>
<p align="center">$H_1$: $\mu_1 \neq \mu_2$ </p>

Вернемся к данным про студентов и нашим вопросам и разберем теперь следующий вопрос:

> 
3. Отличается ли статистически значимо средний балл по математике у тех, кто чаще или реже пропускает занятия?

```{r eval=TRUE, echo = FALSE, message = FALSE}
kable(students[1:10,]) %>% scroll_box(width = "100%") 
```

Мы уже [обсуждали в предыдущей главе](#variables), что ЗП здесь -- средний балл по математике (колонка `G_mat`), НП -- количество пропусков занятий по этом предмету (`absences_mat`). И ЗП, и НП -- количественные, закодированы в шкале отношений. Значит, можем пользоваться той веткой статистических тестов, которая подходит для количественных ЗП.

Пройдем по алгоритму выбора статистического теста: <https://miro.com/app/board/uXjVOxmKhr8=/?share_link_id=245423331470>

Помимо основных отраженных ответвлений, видим, что для каждого критерия существует ряд допущений.

**Допущения (assumptions)** -- это утверждения про характер наших данных, без соблюдения которых параметрические тесты будут работать некорректно (поэтому их никто и не любит).

### Допущения для т-теста

1. Данные распределены нормально (или, если измеряемый признак является случайной велиичной, в группах больше 30 наблюдений) -- обсуждали эту проверку [здесь](#param_nonparam)
2. Дисперсии однородны (гомогенны) -- проверяется с помощью теста Ливеня (Homogeneity of Variance test, он же Levene's test).

### Непараметрические аналоги

В случае, если допущения нормальности и однородности дисперсий нарушаются, мы не можем использовать т-тест. 

<p align="center"> 
```{r eval=TRUE, echo = FALSE, message = FALSE, fig.align = 'center', out.width="70%"}
knitr::include_graphics("docs/images/scheme-t-tests.png")
```
</p>

### Независимые и парные тесты

Тут тоже все довольно просто:

* Если у нас независимые выборки, то мы используем независмый т-тест или его непараметрический аналог -- тест Манна-Уитни.
* Если выборки зависимые, то мы используем парный т-тест или его непараметрический аналог -- тест Вилкоксона.

Обилие наименований может быть пугающим, но по сути, это один и тот же тест с небольшими поправками -- просто в разных названиях увековечено больше статистиков!

### Вычисление т-теста и непараметрических аналогов

Средний балл и стандартное отклонение в группах тех, кто прогуливает меньше всего (на паре мы назвали их прихожанами):

```{r eval=TRUE, echo = FALSE, message = FALSE}
students %>% 
  filter(absences_mat_groups == "less") %>% 
  summarise(mean = mean(G_mat), sd = sd(G_mat), n = length(G_mat))
```
Средний балл в группах прогулищиков:

```{r eval=TRUE, echo = FALSE, message = FALSE}
students %>% 
  filter(absences_mat_groups == "more") %>% 
  summarise(mean = mean(G_mat), sd = sd(G_mat), n = length(G_mat))
```

```{r, eval=TRUE}
students %>% 
  filter(absences_mat_groups != "middle") -> students_2

t.test(students_2$G_mat ~ students_2$absences_mat_groups, paired = FALSE)
```

```{r eval=TRUE, echo = TRUE, warning=FALSE}
students_2 %>% 
  ggplot(aes(x=absences_mat_groups, y = G_mat)) +
  geom_boxplot(aes(fill = absences_mat_groups)) +
  # scale_fill_viridis(discrete=TRUE) +
  theme_minimal()
```

```{r eval=TRUE, echo = TRUE, warning=FALSE}
students_2 %>% 
  ggplot(aes(x=absences_mat_groups, y = G_mat)) +
  geom_violin(aes(fill = absences_mat_groups)) +
  geom_boxplot(aes(fill = absences_mat_groups), width=0.2) +
  stat_summary(fun.y = "mean", colour = "black", size = 2, geom = "point") +
  # stat_summary(fun.data=mean_se, geom="errorbar", color="black", width=0.2) +
  theme_minimal()
```

## ANOVA (дисперсионный анализ)

**ANOVA (ANalysis Of VAriance)** -- статистический критерий, распределение и ключевая статистика которого относятся к семейству F-распределений. Это то чуть скошенное влево распределение, уже сильно отличающееся от нормального. На этом распределении мы (точнее специально обученные программы) будут располагать F-значение, которое будет вычисляться. Этот критерий используется, когда зависимая переменная (ЗП) измерена в метрической (количественной) шкале, а независимые переменные (НП) -- категориальные (порядковые или номинативные). ANOVA применяется, когда число проводимых сравниваемых становится больше двух -- то есть, либо это одна НП, которая может принимать три значения (уровня), либо число НП больше или равно двум. 

**ANOVA используется тогда, когда число сравнений, которые нам нужно сделать, становится больше двух**. Можно сделать и два сравнения с помощью ANOVA, но это будет бессмысленно, так как по сути это старый добрый т-тест. 

Нулевая и альтернативные гипотеза для ANOVA:

<p align="center">$H_0$: $\mu_1 = \mu_2 = ... =\mu_n$ </p>
<p align="center">$H_1$: Есть хотя бы одно неравенство: $\mu_1 \neq \mu_2 \neq ... \neq \mu_n$ </p>


Как вообще получается, что нам нужно сделать больше двух сравнений?

### Факторы и уровни {#levels}

**Фактором** или **предиктором** в линейных моделях и дисперсионном анализе называется независимая переменная. 

Как правило, мы применяем ANOVA для сравнения групп, поэтому эта независимая переменная -- категориальная, она принимает конечное число значений. Значений НП -- это те группы, которые мы сравниваем между собой, они называются **уровнями НП или уровнями фактора**. 

<p align="center"> 
```{r eval=TRUE, echo = FALSE, message = FALSE, fig.align = 'center', out.width="70%"}
knitr::include_graphics("docs/images/levels.png")
```
</p>

В зависимости от числа НП и уровней НП можно конкретизировать экспериментальный план и план для ANOVA:

<p align="center"> 
```{r eval=TRUE, echo = FALSE, message = FALSE, fig.align = 'center', out.width="100%"}
knitr::include_graphics("docs/images/factors_levels.png")
```
</p>


### Почему он дисперсионный

Чтобы перейти к непосредственно анализу, надо немного разобраться, что это воообще за метод, и почему он называется дисперсионным, хотя предположения мы строим, как и в большинстве статистических критериев, относительно средних значений по группам. Дело в том, что этот метод действительно учитывает дисперсию, а точнее, разницу дисперсий. Математика ANOVA основана на том, что при объединении нескольких выборок с примерно одинаковой дисперсией, но разными средним, дисперсия увеличивается пропорционально средним этих значений. Это связано с тем, что всю дисперсию можно разделить на межгрупповую и внутригрупповую. Если окажется, что дисперсия между группами больше, чем внутри, то можно сделать вывод в пользу различий между группами. Для того, чтобы зафиксировать различия между группами, внутригрупповая дисперсия здесь должна быть как можно меньше: чем она меньше внутри групп и больше между групп, тем более серьезный вывод об отличиях групп мы сможем сделать.

F-значение считается, по сути, как отношение дисперсий двух групп.

В качесте дисперсии для математики ANOVA обычно берется только ее числитель, без деления на число элементов в группе ([а саму дисперсию мы считали здесь](#varm). Числитель дисперсии без знаменателя -- **это сумма квадратов (Sum of Squares)**

<p align="center">$D = \frac{\sum_{i=1}^{n} (x_i - \overline{x})^2}{n}$</p>

Заодно вспомним, что стандартное отклонение -- это корень из дисперсии:

<p align="center">$\sigma = \frac{\sum_{i=1}^{n} (x_i - \overline{x})}{\sqrt{n}}$</p>

А сумма кавдратов -- это числитель дисперсии, SST (Sum of Squares Total):

<p align="center"> $SST = \sum_{i=1}^{n} (x_i - \overline{x})^2$</p>

Общая сумма квадратов SST складывается из **межгрупповой** суммы квадратов (SSE, Sum of Squares Explained или SSB, Sum of Squares Between groups) и **внутригрупповой** (SSR, Sum of Squares Random или SSW, Sum of Squares Within groups)

<p align="center"> 
```{r eval=TRUE, echo = FALSE, message = FALSE, fig.align = 'center', out.width="70%"}
knitr::include_graphics("docs/images/anova_SS.jpg")
```
</p>

<p align="center">$SST = SSE + SSR$</p>

Предположим, что у нас есть m групп по n наблюдений в каждой из них (для простоты возьмем равные по численности группы).
Тогда общая сумма квадратов (дисперсия без знаменателя) равна:

<p align="center">$SST = \sum_{i=1}^{m \times n} (x_i - \bar x)^2$</p>


Как вычислить межгрупповую и внутригрупповую сумму квадратов?

<p align="center">$SSE = \sum_{j=1}^m (\bar x_j - \bar x)^2$</p>
<p align="center">$df_{SSE} = m-1$, m -- количество групп </p>

<p align="center">$SSR = \sum_{j=1}^m\sum_{i=1}^n (x_{ij} - \bar x_j)^2$</p>
<p align="center">$df_{SSR} = m \times n - m$, n -- количество элементов во группе, m -- число групп </p>

Желаемый результат здесь -- наименьшее значение SSR (внутригрупповой) и наибольшее SSE (межгрупповой).

Отсюда логически вытекает один из важных показателей для интпреретации результатов ANOVA: 

<p align="center">$R^2 = \frac{SSE}{SST} = 1 - \frac{SSR}{SST}$ -- процент объясненной факторами дисперсии (коэффициент детерминации), то есть то, насколько хорошо наши факторы объясняют изменчивость данных. </p>

А до подсчета F-значения остается один шаг -- посчитать средние суммы квадратов, то есть поделить их на число степененй свобооды для каждой суммы квадратов (точно так же, как мы делили дисперсию на число наблюдений! Возвращаемся к ее смыслу)

<p align="center">$MSE = \frac{SSE}{df_{SSE}} = \frac{SSE}{m-1}$</p>
<p align="center">$MSR = \frac{SSR}{df_{SSR}} = \frac{SSR}{m \times n - m}$</p>

И можем посчитать F-значение, которое будем располагать на F-распределении (напомню, что за нас обычно это делают специально обученные машины)

<p align="center">$F = \frac{MSE}{MSR} = \frac{SSE \times (m \times n - m)}{(m-1) \times SSR}$</p>

### F-распределение (Фишера)

<p align="center"> 
```{r eval=TRUE, echo = FALSE, message = FALSE, fig.align = 'center', out.width="70%"}
knitr::include_graphics("docs/images/F-dist.png")
```
</p>

F-распределение или распределение Фишера -- это распределение величины, которая высчитывается как отношение средних квадратов внутригрупповой и межгрупповой изменчивости (очень похоже на дисперсию) и включает туда рассчитанное количество степеней свободы для внутригрупповой и межгрупповой изменчивости. При очень большой выборке, большом значении степеней свободы, оно тоже будет походить на нормальное!

При малом числе степеней свободы (малой выборке) F-распределение визуально отличается от нормального -- но для проверки допущения это не имеет никакого значения, так как это распределение F-статистик, а не зависимой переменной -- к ним все еще действует допущение о нормальности или большог ообъема выборки.

### Допущения для ANOVA

Пройдем по алгоритму выбора статистического теста: <https://miro.com/app/board/uXjVOxmKhr8=/?share_link_id=245423331470>

Помимо основных отраженных ответвлений, для каждого критерия существует ряд допущений.

Допущения (assumptions) -- это утверждения про  характер наших данных, без соблюдения которых параметрические тесты будут работать некорректно (поэтому их никто и не любит).

1. Данные распределены нормально (или, если измеряемый признак является случайной велиичной, в группах больше 30 наблюдений) -- обсуждали эту проверку [здесь](#param_nonparam)
2. Если независимые -- дисперсии однородны (гомогенны), проверяется с помощью теста Левеня (Levene's Test of Homogeneity of Variance), если зависимые группы -- сферичность дисперсий, проверяется с помощью теста на сферичноость (Sphericity test, Mauchly test)

### Непараметрические аналоги

В случае, если допущения нормальности (помним, что это скорее про большое число наблюдений в выборке и визуально значительное отличие от гауссианы) и однородности дисперсий нарушаются, мы не можем использовать ANOVA, и нужно использовать непараметрические аналоги . 

<p align="center"> 
```{r eval=TRUE, echo = FALSE, message = FALSE, fig.align = 'center', out.width="70%"}
knitr::include_graphics("docs/images/anova-tests.png")
```
</p>

### Просто ANOVA и с повторными измерениями

Тут тоже все довольно просто:

* Если у нас независимые выборки, то мы используем ANOVA или его непараметрический аналог -- тест  Краскелла-Уоллиса.
* Если выборки зависимые, то мы используем ANOVA c повторными измерениями (repeated measures) или его непараметрический аналог -- тест Фридмана.

Обилие наименований может быть пугающим, но по сути, это один и тот же тест с небольшими поправками -- просто в разных названиях увековечено больше статистиков!

### Нелинейные эффекты

Большое преимущество в сравнении трех и более групп -- такие сравнения позволяют выявить нелинейные эффекты.

<p align="center"> 
```{r eval=TRUE, echo = FALSE, message = FALSE, fig.align = 'center', out.width="80%"}
knitr::include_graphics("docs/images/nonlinear.png")
```
</p>

### Многофакторый ANOVA и взаимодействие факторов {#multiple_anova}

Многофакторный ANOVA -- тот же ANOVA, только когда у нас больше одной [независимой переменной (фактора)](#levels). Многофакторный ANOVA обычно обозначается примерно так: $ANOVA \ 2 \times 3$ -- это значит, что у нас два фактора, 2 уровня в первом фактора и 3 уровня во втором.

Многофакторный ANOVA интересен тем, что позволяет изучать еще и взаимодействие этих НП. Нелийность одного фактора может накладываться на нелинейность другого, или эффект фактора может проявиться только в определенных специальных условиях -- за этим нужен многофакторный дизайн. Например, мы исследуем ту же концентрацию кофеина на внимание, даем испытуемым выпить 1 или 2 кружки кофе, а еще хотим поизучать этот эффект в зависимости от времени суток, в которое испытуемые выписывают кофе. Может оказаться, что эффект кофеина на внимание растет с увеличением концентрации кофе, но это происходит только в утренние часы -- а в вечернее время не обнаруживается разница во внимании, 1 и 2 кружки кофе действует абсолютно оодинаково. Это назвается взаимодействием фактором и проявляется, когда у нас в исследовании 2 и более НП.

Визуально взаимодействие проявляется так: если нарисовать график зависимой переменной от одного из факторов и поместить на этот график линию, соответствующую другому фактору, то если линии окажутся не параллельны -- то можно говорить о наличии взаимодействия.

<p align="center"> 
```{r eval=TRUE, echo = FALSE, message = FALSE, fig.align = 'center', out.width="80%"}
knitr::include_graphics("docs/images/anova_interaction1.jpg")
```
Картинка [отсюда](https://angelgardt.github.io/SFDA2022/book/twoway-anova.html#factor_interaction) </p>

В случае нескольких факторов (независимых переменных), расчет и логика применения ANOVA точно такие же, добавляется только еще один фактор и взаимодействие первогоо фактора со вторым:

<p align="center">$SST = SSE_{factor1} + SSE_{factor2} + SSE_{factor1} \times SSE_{factor2} +SSR$</p>

### Пост-хоки и множественные сравнения

Допустим, мы провели ANOVA (любой из его видов), сравнили полученное p-значение с $\alpha$, и оказалось, что p-значение < $\alpha$, и мы можем отвергнуть нулевую гипотезу $H_0$ в пользу альтернативной $H_1$. Значит ли это, что отличаются средние во всех группах? Или может быть так, что $\mu_1 = \mu_2$ и $\mu_1 \neq \mu_3$? Может.

ANOVA говорит, что в каких-то группах есть значимые отличия между средними, но не говорит, в каких именно. А чтобы узнать, в каких группах есть значимые отличия, нужно провести серию пост-хок (post hoc), апостериорных тестов. Это просто попарные т-тесты ([разбирали их здесь](#ttest)) для сравнения каждого уровня НП с каждым, но уже с **поправкой на множественные сравнения**.

Что это за поправки? Они нужны нам, чтобы ибежать увеличения ошибки первого рода. Оказывается, что если мы на оодних и тех же данных будем тестировать несколько гипотез, то вероятность случайно получить статистически значимые различия будет увеличиваться пропорционально количеству тестируемых гипотез, то есть сделанных сравнений! Это происхоодит потому, что нарушается важное предположение о независимости наших выводов.

И вероятность сделать ложноположительный вывод будет уже никак не 0.05, а гораздо больше. Чтобы этого избежать, вводятся поправки на множественные сравнения, которые корректируют уровень $\alpha$ и занижают его. 

Самые популярные поправки:

* Бонферонни
* Тьюки
* FDR

Попарные пост-хок тесты нужны, когда результаты ANOVA оказались значимыми -- это следующий шаг, чтобы разобраться, какие именно уровни факторов или их взаимодействия внесли значимость. Если ANOVA не значим, то последующие попарные сравнения не нужны -- у нас совсем ничего не значимо (вспоминаем, что нулевой гипотезой для ANOVA является наличие хотя бы одного отличающегося среднего), так что и сравнивать нечего.

### Вычисление ANOVA и непараметрических аналогов

Посмотрим опять на данные и поисследуем зависимость балла по математике (переменная `G_mat`) от того, живут ли студенты в городах (переменная `address` значение U (urban)) или деревнях (переменная `address` значение R).

```{r eval=TRUE, echo = FALSE, message = FALSE}
kable(students[1:10,]) %>% scroll_box(width = "100%") 
```

1) Формулируем эмпирическю гипотезу. Уже обсуждали, что ЗП здесь -- `G_mat`, количественная непрерывная. НП -- `address`, категориальная номинативная, включает 2 уровня -- U и  R.

<p align="center">`G_mat` ~ `address`</p>

2) Формулируем нулевую гипотезу:

<p align="center">$H_0$: $\mu_r = \mu_u$ </p>
<p align="center">$H_1$: $\mu_r \neq \mu_u$ </p>

3) Зафиксируем, что будем проверять гипотезу на уровне $\alpha = 0.05$

4) Выберем статистический критерий для проверки. Сделаем проверку ЗП на нормальность и сравним дисперсии двух выборок. 

```{r, eval=TRUE, message = FALSE, warning= FALSE, out.width="60%"}
students %>% 
  ggplot(aes(x=G_mat, y = ..density..)) +
  geom_histogram() +
  geom_density() +
  theme_minimal()
```
```{r, eval=TRUE, message = FALSE, warning= FALSE, out.width="60%"}
students %>% 
  ggplot(aes(sample=G_mat)) +
  stat_qq() +
  stat_qq_line() +
  theme_minimal()
```

5) В нашем случае критерий -- однофакторный ANOVA с независимыми выборками. Вычислим его

```{r, eval=TRUE, message = FALSE, warning= FALSE}
library("ez")
model_abs_mat_ez <-  ezANOVA(data = students, dv = G_mat, wid = student,
                           between = Mjob)
model_abs_mat_ez
summary(model_abs_mat_ez)
```

6) Как интпрерпретировать результаты? Ключевая для нас статистика -- это F-значение

Еще хорошую и более поробную главу (даже две) про ANOVA написал мой друг и коллега Антон Ангельгардт, если интересно углубиться, можно почитать его материал.
https://angelgardt.github.io/SFDA2022/book/oneway-anova.html
```{r, eval=TRUE, message = FALSE, warning= FALSE}
model_abs_mat_ez <-  ezANOVA(data = students, dv = G_mat, wid = student,
                           between = Mjob)
model_abs_mat_ez
summary(model_abs_mat_ez)
```

```{r}
students %>% 
  ggplot(aes(x=Mjob, y = G_mat)) +
  geom_boxplot(aes(fill = Mjob)) +
  scale_fill_viridis(discrete=TRUE) +
  # stat_summary(fun.data=mean_se, geom="errorbar", color="black", width=0.2) +
  theme_minimal()
```

```{r, eval=TRUE}
students %>% 
  ggplot(aes(x=Mjob, y = G_mat)) +
  geom_violin(aes(fill = Mjob)) +
  geom_boxplot(aes(fill = Mjob), width=.1) +
  scale_fill_viridis(discrete=TRUE) +
  theme_minimal()
```
```{r}
# students %>% 
#   ggplot(aes(x=Mjob, y = G_mat)) +
#   geom_point(aes(fill = Mjob)) +
#   scale_fill_viridis(discrete=TRUE) +
#   stat_summary(fun.data=mean_se, geom="errorbar", color="black", width=0.2) +
#   theme_minimal()
```
